p8105 Homework 6
================
Tory Lynch
November 26, 2018

#### Problem 1

``` r
#Load and clean data 
homicide_data = read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "), 
    resolution = case_when(
      disposition == "Closed without arrest" ~ "unsolved", 
      disposition == "Open/No arrest" ~ "unsolved", 
      disposition == "Closed by arrest" ~ "solved"
    )
  ) %>% 
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>% 
  mutate(
    race = as.factor(case_when(
      victim_race == "White" ~ "white", 
      victim_race != "White" ~ "non-white"
    ))
  ) %>% 
  mutate(age = as.numeric(victim_age)) %>% 
  mutate(race = fct_relevel(race, "white")) %>% 
  mutate(sex = fct_relevel(victim_sex, "Female")) %>% 
  mutate(resolution = fct_relevel(resolution, "unsolved"))
```

##### Logistic model for Baltimore, MD

``` r
logistic_model = homicide_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolution ~ age + sex + race, data = ., family = binomial())

logistic_model %>% 
  broom::tidy(., conf.int = TRUE) %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)) %>% 
  dplyr::select(term, OR, ci.high, ci.low) %>% 
  mutate(term = str_replace(term, "racenon-white", "race: non-white")) %>% 
  mutate(term = str_replace(term, "sexMale", "sex: male")) %>% 
  knitr::kable(digits = 4)
```

| term            |      OR|  ci.high|  ci.low|
|:----------------|-------:|--------:|-------:|
| (Intercept)     |  3.2741|   5.2122|  2.0760|
| age             |  0.9930|   0.9994|  0.9867|
| sex: male       |  0.4116|   0.5369|  0.3148|
| race: non-white |  0.4406|   0.6197|  0.3122|

##### Logistic model for all cities

I ran adjusted and unadjusted logistic regression models that showed the odds of homicides being resolved for non-white victims compared to white victims. The adjusted models took into account the age and sex of the victim, while the uadjusted model did not.

###### Adjusted for age and sex

``` r
#Model adjusted for age and sex
nested_adjusetd_homicide = homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(resolution ~ race + age + sex, data = ., family = binomial())),
         model = map(model, broom::tidy, conf.int = TRUE)) %>% 
  dplyr::select(-data) %>%    
  unnest() %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)
  ) %>% 
  filter(term == "racenon-white") %>% 
  dplyr::select(city_state, OR, ci.high, ci.low) 

  nested_adjusetd_homicide %>% 
    knitr::kable(digits = 3, 
               col.names = c("City", "OR", "High CI", "Low CI"))
```

| City               |     OR|  High CI|  Low CI|
|:-------------------|------:|--------:|-------:|
| Albuquerque, NM    |  0.739|    1.220|   0.445|
| Atlanta, GA        |  0.753|    1.299|   0.424|
| Baltimore, MD      |  0.441|    0.620|   0.312|
| Baton Rouge, LA    |  0.668|    1.405|   0.304|
| Birmingham, AL     |  1.039|    1.754|   0.612|
| Boston, MA         |  0.127|    0.285|   0.047|
| Buffalo, NY        |  0.392|    0.714|   0.211|
| Charlotte, NC      |  0.558|    0.951|   0.313|
| Chicago, IL        |  0.562|    0.734|   0.432|
| Cincinnati, OH     |  0.318|    0.541|   0.180|
| Columbus, OH       |  0.861|    1.161|   0.638|
| Denver, CO         |  0.602|    1.008|   0.358|
| Detroit, MI        |  0.652|    0.870|   0.488|
| Durham, NC         |  1.003|    2.452|   0.390|
| Fort Worth, TX     |  0.838|    1.264|   0.553|
| Fresno, CA         |  0.445|    0.841|   0.221|
| Houston, TX        |  0.873|    1.090|   0.698|
| Indianapolis, IN   |  0.505|    0.665|   0.381|
| Jacksonville, FL   |  0.658|    0.862|   0.502|
| Las Vegas, NV      |  0.763|    0.981|   0.591|
| Long Beach, CA     |  0.794|    1.606|   0.379|
| Los Angeles, CA    |  0.666|    0.916|   0.481|
| Louisville, KY     |  0.392|    0.590|   0.257|
| Memphis, TN        |  0.778|    1.154|   0.516|
| Miami, FL          |  0.577|    0.885|   0.376|
| Milwaukee, wI      |  0.632|    0.982|   0.398|
| Minneapolis, MN    |  0.646|    1.204|   0.341|
| Nashville, TN      |  0.902|    1.239|   0.655|
| New Orleans, LA    |  0.467|    0.739|   0.295|
| New York, NY       |  0.532|    0.989|   0.271|
| Oakland, CA        |  0.213|    0.418|   0.099|
| Oklahoma City, OK  |  0.681|    0.970|   0.477|
| Omaha, NE          |  0.170|    0.300|   0.091|
| Philadelphia, PA   |  0.644|    0.850|   0.485|
| Pittsburgh, PA     |  0.282|    0.485|   0.157|
| Richmond, VA       |  0.447|    1.150|   0.144|
| San Antonio, TX    |  0.689|    1.026|   0.459|
| Sacramento, CA     |  0.781|    1.348|   0.443|
| Savannah, GA       |  0.605|    1.277|   0.279|
| San Bernardino, CA |  0.880|    1.999|   0.394|
| San Diego, CA      |  0.483|    0.778|   0.294|
| San Francisco, CA  |  0.458|    0.719|   0.288|
| St. Louis, MO      |  0.577|    0.819|   0.405|
| Stockton, CA       |  0.376|    0.713|   0.193|
| Tampa, FL          |  1.159|    2.293|   0.585|
| Tulsa, OK          |  0.596|    0.866|   0.406|
| Washington, DC     |  0.514|    0.997|   0.252|

``` r
#Plot for adjusted model 
 nested_adjusetd_homicide %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci.low, ymax = ci.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Odds of solving homicides of non-white victims compared to white victims
    in 47 American cities between 2007 - 2015",
    x = "City", 
    y = "Adjusted OR", 
    caption = "Data source: Washington Post
               Model adjusted for race and age"
  )
```

![](p8105_hw6_vdl2103_files/figure-markdown_github/adj%20model%20plot-1.png)

###### Unadjusted model

``` r
#Unadjusted model 
 nested_unadj_homicide = homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(resolution ~ race, data = ., family = binomial())),
         model = map(model, broom::tidy, conf.int = TRUE)) %>% 
  dplyr::select(-data) %>%    
  unnest() %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)
  ) %>% 
  filter(term == "racenon-white") %>% 
  dplyr::select(city_state, OR, ci.high, ci.low) 

nested_unadj_homicide %>% 
  knitr::kable(digits = 3, 
               col.names = c("City", "OR", "High CI", "Low CI"))
```

| City               |     OR|  High CI|  Low CI|
|:-------------------|------:|--------:|-------:|
| Albuquerque, NM    |  0.807|    1.302|   0.499|
| Atlanta, GA        |  0.835|    1.425|   0.476|
| Baltimore, MD      |  0.386|    0.534|   0.278|
| Baton Rouge, LA    |  0.581|    1.181|   0.273|
| Birmingham, AL     |  1.128|    1.876|   0.675|
| Boston, MA         |  0.098|    0.215|   0.037|
| Buffalo, NY        |  0.351|    0.619|   0.194|
| Charlotte, NC      |  0.581|    0.960|   0.336|
| Chicago, IL        |  0.482|    0.623|   0.373|
| Cincinnati, OH     |  0.310|    0.514|   0.180|
| Columbus, OH       |  0.740|    0.979|   0.559|
| Denver, CO         |  0.597|    0.969|   0.366|
| Detroit, MI        |  0.617|    0.819|   0.464|
| Durham, NC         |  0.909|    2.079|   0.374|
| Fort Worth, TX     |  0.991|    1.463|   0.669|
| Fresno, CA         |  0.433|    0.798|   0.220|
| Houston, TX        |  0.899|    1.115|   0.724|
| Indianapolis, IN   |  0.527|    0.683|   0.405|
| Jacksonville, FL   |  0.660|    0.850|   0.511|
| Las Vegas, NV      |  0.802|    1.013|   0.633|
| Long Beach, CA     |  0.631|    1.213|   0.314|
| Los Angeles, CA    |  0.611|    0.826|   0.449|
| Louisville, KY     |  0.386|    0.564|   0.261|
| Memphis, TN        |  0.922|    1.344|   0.622|
| Miami, FL          |  0.573|    0.866|   0.380|
| Milwaukee, wI      |  0.687|    1.053|   0.439|
| Minneapolis, MN    |  0.575|    1.045|   0.310|
| Nashville, TN      |  0.920|    1.256|   0.671|
| New Orleans, LA    |  0.579|    0.895|   0.375|
| New York, NY       |  0.441|    0.799|   0.229|
| Oakland, CA        |  0.185|    0.358|   0.087|
| Oklahoma City, OK  |  0.685|    0.950|   0.493|
| Omaha, NE          |  0.144|    0.249|   0.078|
| Philadelphia, PA   |  0.576|    0.753|   0.437|
| Pittsburgh, PA     |  0.243|    0.412|   0.138|
| Richmond, VA       |  0.494|    1.213|   0.164|
| San Antonio, TX    |  0.768|    1.127|   0.518|
| Sacramento, CA     |  0.707|    1.195|   0.409|
| Savannah, GA       |  0.618|    1.207|   0.308|
| San Bernardino, CA |  0.722|    1.555|   0.340|
| San Diego, CA      |  0.472|    0.738|   0.296|
| San Francisco, CA  |  0.336|    0.515|   0.216|
| St. Louis, MO      |  0.584|    0.822|   0.413|
| Stockton, CA       |  0.386|    0.717|   0.203|
| Tampa, FL          |  1.131|    2.142|   0.596|
| Tulsa, OK          |  0.620|    0.888|   0.430|
| Washington, DC     |  0.566|    1.076|   0.282|

``` r
#Unadjusted model plot
  nested_unadj_homicide %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci.low, ymax = ci.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Odds of solving homicides of non-white victims compared to white victims
    in 47 American cities between 2007 - 2015",
    x = "City", 
    y = "OR", 
    caption = "Data source: Washington Post
               Unadjusted model"
  )
```

![](p8105_hw6_vdl2103_files/figure-markdown_github/unadj%20model%20plot-1.png)

#### Problem 2

``` r
birthwt_data = read_csv("data/birthweight.csv", na = c("", "NA", "Unknown")) %>% 
  dplyr::select(bwt, fincome, frace, mrace, gaweeks, smoken, blength, bhead, babysex) %>% 
  mutate(
    babysex = as.factor(case_when(
      babysex == 2 ~ "female", 
      babysex == 1 ~ "male"
    )), 
    frace = as.factor(case_when(
      frace == 1 ~ "white", 
      frace != 1 ~ "non-white"
    )), 
    mrace = as.factor(case_when(
      mrace == 1 ~ "white", 
      mrace != 1 ~ "non-white"
    ))
  ) %>% 
  mutate(sex = fct_relevel(babysex, "female")) %>% 
  mutate(race_m = fct_relevel(mrace, "white")) %>% 
  mutate(race_f = fct_relevel(frace, "white"))
```

There are no missing data.

``` r
colMeans(is.na(birthwt_data)) %>% 
  knitr::kable()
```

|         |    x|
|---------|----:|
| bwt     |    0|
| fincome |    0|
| frace   |    0|
| mrace   |    0|
| gaweeks |    0|
| smoken  |    0|
| blength |    0|
| bhead   |    0|
| babysex |    0|
| sex     |    0|
| race\_m |    0|
| race\_f |    0|

I hypothesized that variables related to socioeconomic status have a significant effect on birthweight. I selected race (mother and father), income, number of cigarettes smoked per day during pregnancy and gestational weeks as the variables that best capture SES among those in the birthweight dataset. I included gestational age as a proxy for SES variables related to a mother's underlying health and her access to quality healthcare; women with limited access to quality healthcare and pre-existing health conditions may be more likley to have babies with shorter gestational periods.

I ran a linear regression with just the SES-related variables (full model). I also used stepwise linear regression, with stepwise selection, to identify the subset of the SES-related variables that leads to the best performing model according to AIC (step model).

``` r
SES_var = birthwt_data %>% 
  dplyr::select(bwt, race_m, race_f, fincome, gaweeks, smoken) 

full_SES_model = lm(bwt ~ ., data = SES_var)
step_SES_model = stepAIC(full_SES_model, direction = "both", trace = FALSE)
summary(step_SES_model) %>% 
  broom::tidy() %>% 
  mutate(term = str_replace(term, "race_mnon-white", "Race: non-white")) %>% 
  mutate(term = str_replace(term, "fincome", "Income")) %>% 
  mutate(term = str_replace(term, "gaweeks", "Gestational weeks")) %>% 
  mutate(term = str_replace(term, "smoken", "Cigarettes smoked per day")) %>% 
  knitr::kable(digits = 4)
```

| term                      |   estimate|  std.error|  statistic|  p.value|
|:--------------------------|----------:|----------:|----------:|--------:|
| (Intercept)               |   912.2229|    88.9152|    10.2595|   0.0000|
| Race: non-white           |  -262.8597|    15.3809|   -17.0900|   0.0000|
| Income                    |     0.5063|     0.2841|     1.7824|   0.0748|
| Gestational weeks         |    59.7971|     2.1831|    27.3908|   0.0000|
| Cigarettes smoked per day |   -10.8175|     0.9450|   -11.4466|   0.0000|

``` r
summary(step_SES_model) %>% 
  broom::glance() %>% 
  knitr::kable(digits = 4)
```

|       |  r.squared|  adj.r.squared|     sigma|  statistic|  p.value|   df|
|-------|----------:|--------------:|---------:|----------:|--------:|----:|
| value |     0.2431|         0.2424|  445.7857|   348.1978|        0|    5|

``` r
SES_model_pred = SES_var %>% modelr::add_predictions(., step_SES_model) %>% 
  mutate(id = rownames(SES_var))
SES_model_resid = modelr::add_residuals(SES_var, step_SES_model) %>% 
  mutate(id = rownames(SES_var))

SES_model_pred %>% inner_join(SES_model_resid, by = "id") %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() + 
  geom_smooth() + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Plot of residuals vs. fitted values", 
    x = "Fitted values", 
    y = "Residuals", 
    caption = "linear model with SES-related variables selected by stepwise linear regression"
  )
```

    ## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'

![](p8105_hw6_vdl2103_files/figure-markdown_github/resid%20vs.%20fitted%20plot-1.png)

The residual vs. fitted plot shows that some outliers may be influencing the

``` r
lm(bwt ~ blength + gaweeks, data = birthwt_data)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ blength + gaweeks, data = birthwt_data)
    ## 
    ## Coefficients:
    ## (Intercept)      blength      gaweeks  
    ##    -4347.67       128.56        27.05

``` r
lm(bwt ~ bhead + blength + sex + bhead*blength + bhead*sex + blength*sex + bhead*blength*sex, data = birthwt_data)
```

    ## 
    ## Call:
    ## lm(formula = bwt ~ bhead + blength + sex + bhead * blength + 
    ##     bhead * sex + blength * sex + bhead * blength * sex, data = birthwt_data)
    ## 
    ## Coefficients:
    ##           (Intercept)                  bhead                blength  
    ##              -801.949                -16.598                -21.646  
    ##               sexmale          bhead:blength          bhead:sexmale  
    ##             -6374.868                  3.324                198.393  
    ##       blength:sexmale  bhead:blength:sexmale  
    ##               123.773                 -3.878
