---
title: "p8105 Homework 6"
output: github_document
author: Tory Lynch
date: November 26, 2018
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
library(mgcv)
library(MASS)
```

#### Problem 1
```{r load and clean homicide data, message = FALSE}
#Load and clean data 
homicide_data = read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "), 
    resolution = case_when(
      disposition == "Closed without arrest" ~ "unsolved", 
      disposition == "Open/No arrest" ~ "unsolved", 
      disposition == "Closed by arrest" ~ "solved"
    )
  ) %>% 
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) %>% 
  mutate(
    race = as.factor(case_when(
      victim_race == "White" ~ "white", 
      victim_race != "White" ~ "non-white"
    ))
  ) %>% 
  mutate(age = as.numeric(victim_age)) %>% 
  mutate(race = fct_relevel(race, "white")) %>% 
  mutate(sex = fct_relevel(victim_sex, "Female")) %>% 
  mutate(resolution = fct_relevel(resolution, "unsolved"))
```

##### Logistic model for Baltimore, MD
```{r Baltimore model}
logistic_model = homicide_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolution ~ age + sex + race, data = ., family = binomial())

logistic_model %>% 
  broom::tidy(., conf.int = TRUE) %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)) %>% 
  dplyr::select(term, OR, ci.high, ci.low) %>% 
  mutate(term = str_replace(term, "racenon-white", "race: non-white")) %>% 
  mutate(term = str_replace(term, "sexMale", "sex: male")) %>% 
  knitr::kable(digits = 4)
```

##### Logistic model for all cities 
I ran adjusted and unadjusted logistic regression models that showed the odds of homicides being resolved for non-white victims compared to white victims. The adjusted models took into account the age and sex of the victim, while the uadjusted model did not. 

###### Adjusted for age and sex 
```{r all cities: adj model}
#Model adjusted for age and sex
nested_adjusetd_homicide = homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(resolution ~ race + age + sex, data = ., family = binomial())),
         model = map(model, broom::tidy, conf.int = TRUE)) %>% 
  dplyr::select(-data) %>%    
  unnest() %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)
  ) %>% 
  filter(term == "racenon-white") %>% 
  dplyr::select(city_state, OR, ci.high, ci.low) 

  nested_adjusetd_homicide %>% 
    knitr::kable(digits = 3, 
               col.names = c("City", "OR", "High CI", "Low CI"))
```

```{r adj model plot}
#Plot for adjusted model 
 nested_adjusetd_homicide %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci.low, ymax = ci.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Odds of solving homicides of non-white victims compared to white victims
    in 47 American cities between 2007 - 2015",
    x = "City", 
    y = "Adjusted OR", 
    caption = "Data source: Washington Post
               Model adjusted for race and age"
  )
```

###### Unadjusted model 
```{r all cities: unadj model}
#Unadjusted model 
 nested_unadj_homicide = homicide_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(resolution ~ race, data = ., family = binomial())),
         model = map(model, broom::tidy, conf.int = TRUE)) %>% 
  dplyr::select(-data) %>%    
  unnest() %>% 
  mutate(
    OR = exp(estimate), 
    ci.high = exp(conf.high),
    ci.low = exp(conf.low)
  ) %>% 
  filter(term == "racenon-white") %>% 
  dplyr::select(city_state, OR, ci.high, ci.low) 

nested_unadj_homicide %>% 
  knitr::kable(digits = 3, 
               col.names = c("City", "OR", "High CI", "Low CI"))
```
 
```{r unadj model plot}
#Unadjusted model plot
  nested_unadj_homicide %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = ci.low, ymax = ci.high)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Odds of solving homicides of non-white victims compared to white victims
    in 47 American cities between 2007 - 2015",
    x = "City", 
    y = "OR", 
    caption = "Data source: Washington Post
               Unadjusted model"
  )
```
 
The results from the adjusted and unadjusted plots are similar in that the direction and significance of the odds ratios are unchanged. The unadjusted model has slighlty narrower confidence intervals, in general, and the value of the ORs differs slightly between the two models. The plots show that the odds of solving a homicide where the victim is non-white are significantly lower compared to homicides where the victim is white in most of these cities. There is no clear geographic pattern to this association; the five cities with the lowest odds ratios (and therefore the greatest disparity between solving homicides of white vs. non-white victims) are Boston, Omaha, Oakland, Pittsburgh, and Cincinnati, which represent a wide geographic range. Most of the southern cities do not have statistically significant odds ratios, though the direction of the odds ratios is consistent with the other cities. Birmingham and Tampa are the only cities where the odds of solving a homicide where the victim is non-white is greater than if the victim is white, though neither odds ratio is significant. 

#### Problem 2 
```{r load and clean birthwt data, message = FALSE}
birthwt_data = read_csv("data/birthweight.csv", na = c("", "NA", "Unknown")) %>% 
  dplyr::select(bwt, fincome, frace, mrace, gaweeks, smoken, blength, bhead, babysex) %>% 
  mutate(
    babysex = as.factor(case_when(
      babysex == 2 ~ "female", 
      babysex == 1 ~ "male"
    )), 
    frace = as.factor(case_when(
      frace == 1 ~ "white", 
      frace != 1 ~ "non-white"
    )), 
    mrace = as.factor(case_when(
      mrace == 1 ~ "white", 
      mrace != 1 ~ "non-white"
    ))
  ) %>% 
  mutate(sex = fct_relevel(babysex, "female")) %>% 
  mutate(race_m = fct_relevel(mrace, "white")) %>% 
  mutate(race_f = fct_relevel(frace, "white"))


```

There are no missing data. 
```{r}
colMeans(is.na(birthwt_data)) %>% 
  knitr::kable()
```

I hypothesized that variables related to socioeconomic status have a significant effect on birthweight. I selected race (mother and father), income, number of cigarettes smoked per day during pregnancy and gestational weeks as the variables that best capture SES among those in the birthweight dataset. I included gestational age as a proxy for SES variables related to a mother's underlying health and her access to quality healthcare; women with limited access to quality healthcare and pre-existing health conditions may be more likley to have babies with shorter gestational periods. 

I ran a linear regression with just the SES-related variables (full model). I also used stepwise linear regression, with stepwise selection, to identify the subset of the SES-related variables that leads to the best performing model according to AIC (step model). 
```{r SES regression models}
SES_var = birthwt_data %>% 
  dplyr::select(bwt, race_m, race_f, fincome, gaweeks, smoken) 

full_SES_model = lm(bwt ~ ., data = SES_var)
step_SES_model = stepAIC(full_SES_model, direction = "both", trace = FALSE)
summary(step_SES_model) %>% 
  broom::tidy() %>% 
  mutate(term = str_replace(term, "race_mnon-white", "Race: non-white")) %>% 
  mutate(term = str_replace(term, "fincome", "Income")) %>% 
  mutate(term = str_replace(term, "gaweeks", "Gestational weeks")) %>% 
  mutate(term = str_replace(term, "smoken", "Cigarettes smoked per day")) %>% 
  knitr::kable(digits = 4)
```

```{r SES model fit statistics}
summary(step_SES_model) %>% 
  broom::glance() %>% 
  knitr::kable(digits = 4)
```

```{r resid vs. fitted plot}
SES_model_pred = SES_var %>% modelr::add_predictions(., step_SES_model) %>% 
  mutate(id = rownames(SES_var))
SES_model_resid = modelr::add_residuals(SES_var, step_SES_model) %>% 
  mutate(id = rownames(SES_var))

SES_model_pred %>% inner_join(SES_model_resid, by = "id") %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() + 
  geom_smooth() + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Plot of residuals vs. fitted values", 
    x = "Fitted values", 
    y = "Residuals", 
    caption = "linear model with SES-related variables selected by stepwise linear regression"
  )
```

The residual vs. fitted plot shows that some outliers may be influencing the 

```{r model comparisons}

cv_bwt_data = crossv_mc(birthwt_data, 100)

model_comparison = cv_bwt_data %>% 
  mutate(ses_model = map(train, ~lm(bwt ~ race_m + fincome + gaweeks + smoken, data = .x)),
         age_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)), 
         sex_mod = map(train, ~lm(bwt ~ bhead + blength + sex + bhead*blength + bhead*sex + 
                                                 blength*sex + bhead*blength*sex, data = .x))
         ) %>% 
  mutate(rmse_ses = map2_dbl(ses_model, test, ~rmse(model = .x, data = .y)),
         rmse_age = map2_dbl(age_mod, test, ~rmse(model = .x, data = .y)),
         rmse_sex = map2_dbl(sex_mod, test, ~rmse(model = .x, data = .y))
         )
```

```{r rmse comparison plot}
model_comparison %>% 
  dplyr::select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin() + 
  theme(plot.title = element_text(hjust = 0.5)) +
  labs(
    title = "Violin plot comparing RMSE from SES, Length-Age, and Length-Sex Models", 
    x = "Model", 
    y = "RMSE"
  )
```

